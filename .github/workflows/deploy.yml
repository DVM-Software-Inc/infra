name: Reusable VPS Deploy

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      compose_file:
        type: string
        required: true
      image_name:
        type: string
        required: true
    secrets:
      GHCR_USERNAME:
        required: false
      GHCR_TOKEN:
        required: false
      VPS_HOST:
        required: false
      VPS_USER:
        required: false
      VPS_SSH_KEY:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write SSH Key
        run: |
          echo "${{ secrets.VPS_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
            cd /opt/apps/${{ inputs.image_name }}
            docker compose pull
            docker compose up -d
          "
